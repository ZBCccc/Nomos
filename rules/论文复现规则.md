# 论文复现强制规则

## 核心原则

**本项目是学术论文复现工程,必须严格遵循原论文的设计和规范。任何偏离论文的实现都必须有明确的理由和文档记录。**

## 强制约束

### 1. 协议忠实性 (Protocol Fidelity)

**规则**: 所有密码学协议必须严格按照论文描述实现,不得擅自修改。

**具体要求**:
- 算法伪代码必须与论文中的算法描述一一对应
- 密钥生成、加密、解密、搜索等核心操作必须使用论文指定的密码学原语
- 数据结构 (TSet, XSet, 等) 必须与论文定义一致
- 通信轮次和消息格式必须与论文协议流程匹配

**禁止行为**:
- ❌ 使用论文未提及的密码学原语替代
- ❌ 修改协议流程 (如合并步骤、改变顺序)
- ❌ 简化安全关键的检查或验证步骤
- ❌ 引入论文未描述的优化 (除非在独立的实验分支中)

**例外情况**:
- ✅ 论文未明确指定的实现细节 (如内存管理、数据序列化)
- ✅ 工程优化 (如缓存、并行化),但不能改变协议语义
- ✅ 错误处理和边界检查 (论文通常省略这些)

### 2. 参数一致性 (Parameter Consistency)

**规则**: 所有密码学参数必须与论文设置保持一致。

**强制参数** (来自 Bag et al. 2024):
- **安全参数 λ**: 128 bits (论文 Section 3.1)
- **交叉标签数量 ℓ**: 论文中未明确指定,当前实现使用 ℓ=3
- **采样数量 k**: 论文中未明确指定,当前实现使用 k=2
- **哈希函数**: SHA-256 或更强 (用于 PRF 和承诺)
- **椭圆曲线**: BN254 或 BLS12-381 (用于配对运算)

**参数修改流程**:
1. 在 `docs/parameter-deviations.md` 中记录偏离原因
2. 引用论文中的相关讨论或实验设置
3. 在代码注释中标注 `// DEVIATION: [原因]`

### 3. 算法映射 (Algorithm Mapping)

**规则**: 每个实现的函数必须能追溯到论文中的对应算法。

**强制要求**:
- 在每个核心函数的注释中标注对应的论文算法编号
- 格式: `// Paper: Algorithm X (Section Y.Z)`
- 变量命名尽量与论文符号一致 (如 Ks, Ky, Km, stag, xtag)

**示例**:
```cpp
// Paper: Algorithm 1 - Setup (Section 4.1)
void Gatekeeper::Setup() {
    // Generate master keys: Ks, Ky, Km
    // ...
}

// Paper: Algorithm 3 - Search (Section 4.3)
std::vector<std::string> Server::Search(const TrapdoorMetadata& trapdoor) {
    // Phase 1: Candidate enumeration using stokens
    // Phase 2: Cross-filtering using xtokens
    // ...
}
```

### 4. 安全性保证 (Security Guarantees)

**规则**: 不得削弱论文声称的安全性保证。

**必须保持**:
- **前向隐私** (Forward Privacy): 新增更新不泄露与历史查询的关联
- **Type-II 后向隐私** (Type-II Backward Privacy): 删除操作不泄露被删除文档的内容
- **查询隐私** (Query Privacy): 服务器无法从搜索令牌推断查询关键词

**禁止行为**:
- ❌ 在明文中存储应加密的数据
- ❌ 重用应该唯一的随机数或密钥
- ❌ 跳过论文中的安全关键步骤 (如 OPRF 盲化)
- ❌ 在日志中输出敏感信息 (密钥、明文关键词、文档 ID)

### 5. 实验设置 (Experimental Setup)

**规则**: 性能评估必须使用论文中的实验设置。

**论文实验设置** (Section 6):
- 数据集: Enron Email Dataset (约 500,000 封邮件)
- 关键词数量: 根据数据集统计
- 查询模式: 单关键词查询 + 多关键词布尔查询
- 评估指标: 搜索时间、更新时间、存储开销、通信开销

**当前实现**:
- 使用简化的测试数据集 (开发阶段)
- 需要在正式评估时切换到论文数据集

### 6. 代码审查检查点 (Code Review Checkpoints)

**在提交代码前必须检查**:

- [ ] 是否有对应的论文算法引用?
- [ ] 参数设置是否与论文一致?
- [ ] 是否引入了论文未提及的密码学操作?
- [ ] 是否削弱了安全性保证?
- [ ] 变量命名是否与论文符号对应?
- [ ] 是否在注释中解释了与论文的偏离?

### 7. 偏离记录 (Deviation Documentation)

**规则**: 任何与论文不一致的实现必须记录在案。

**记录位置**: `docs/parameter-deviations.md`

**记录格式**:
```markdown
## [偏离项目名称]

**论文描述**: [论文中的原始描述]
**当前实现**: [实际实现方式]
**偏离原因**: [为什么需要偏离]
**影响分析**: [对安全性/性能的影响]
**论文依据**: [论文中支持此偏离的讨论,如果有]
```

## 开发流程集成

### Phase 0: 实施前辩论
- Codex 必须检查实现计划是否符合论文描述
- 如果发现协议偏离,必须标记为严重问题

### Phase 1: 内部验证
- 代码审查者必须验证算法映射的正确性
- 检查参数设置是否与论文一致

### Phase 2: Codex 审计
- Codex 必须重点审计密码学协议的忠实性
- 检查是否有未记录的偏离

## 论文参考路径

**主论文**: `/Users/cyan/code/paper/ref-thesis/Bag 等 - 2024 - Tokenised Multi-client Provisioning for Dynamic Searchable Encryption with Forward and Backward Priv.pdf`

**研究笔记**: `/Users/cyan/code/paper/docs/`

**在实现前必须阅读**:
- 论文 Section 3: Preliminaries (密码学原语定义)
- 论文 Section 4: Nomos Construction (协议描述)
- 论文 Section 5: Security Analysis (安全性证明)

## 违规处理

**如果发现违反复现规则的代码**:
1. 立即停止实施
2. 在 `docs/parameter-deviations.md` 中记录偏离
3. 评估是否需要回退到论文规范
4. 如果偏离无法避免,升级给用户决策

**状态标记**:
- ✅ 符合论文规范
- ⚠️ 有偏离但已记录
- 🛑 违反复现规则,需要修复
